<!--
Ported by Gavin Delphia in 2015
-->

<!DOCTYPE html>
<html lang="en">

<head>
<title>champGG itemSet utility</title>

    <link href="bootstrap.min.css" rel="stylesheet">
<style>
html {
  font-family: sans-serif;
  -webkit-text-size-adjust: 100%;
	  -ms-text-size-adjust: 100%;
}
body{
	margin: 5px;
}
div {
	border: 0px solid;
}
td{
	cursor: help;
}
</style>


<script>
var App = {
	//Experimental feature to save the files to the league directory rather than the ItemSets directory
	leagueDirectory: "", 
	count: {started: 0, finished: 0},
	patch: "",
	sync: false,
	startSkillsNum: 5, //How many skills to show to start
	queue: [],
	ini:function(){
		document.getElementById('ui2').style.display = "none";
		App.readSettings();

		//Remove old patch settings. Does not effect any custom sets made in the league client
		if (App.isChecked('remold')){	
			App.rmdir(App.leagueDirectory);
			App.mkdir(App.leagueDirectory);
		}

		App.getAllSets();
		// App.getOneSet("Fizz", "Top");
		// App.getOneSet("Fizz", "Middle");
		// App.getOneSet("Fizz", "Jungle");
		// App.getOneSet("Kayle", "Top");
		// App.getOneSet("Kayle", "ADC");
		// App.getOneSet("Kayle", "Jungle");
		//Middle, ADC, Top, Jungle, Support

		document.getElementById("ui").style.display = "none";
		document.getElementById("output").style.display = "block";
	},
	clean:function(){
		App.rmdir("locales");
	},
	getAllSets:function(){
		App.getPage("http://champion.gg/", function(data){App.getAllSetsCB(data)});
	},
	getAllSetsCB:function(data){
		if (data){
			//console.log("Creating item sets for all champions...");

			if (App.sync){
				App.log("Single Request mode enabled", "#0000ee");
			}

			App.log("Creating item sets for all champions...", "#c0c0c0");
			var saveFolder = "ItemSets/" + App.betterDate() + " - ";
			var list = data.match(/<a href="([^"]*)" style="display:block">/g);
			App.patch = App.getBetween(data, "<small>Patch <strong>", "</strong>");
			App.log("Champion.gg item set data is for patch " + App.patch + "<br>", "#c0c0c0");
			App.queue = [];

			if (App.leagueDirectory){
				saveFolder = App.leagueDirectory;
				App.log("Auto Save Feature Enabled", "#0000ee");
				App.log(saveFolder + "<br>", "#0000ee");
			}

			for (var champPage in list){
				App.updateCount(true);
				var data = list[champPage].split("/");
				var champ = data[2];
				var role = data[3].split('"')[0];
				var url = "http://champion.gg/champion/" + champ + "/" + role;

				var passon = {champ:champ, role:role, saveFolder: saveFolder};

				if (App.sync){
					App.queue.push({passon: passon, url: url});
				} else {
					App.getPage(url, function(data, passon){App.getOneSetCB(data, passon)}, passon);
				}
			}

			if (App.sync){
				App.getAllSetsSync_Next();
			}

		} else {
			App.log("Error: No data returned from champion.gg", "#ff0000");
			//console.log("Error");
		}
	},
	getAllSetsSync_Next:function(){
		if (App.queue.length > 0){
			var obj = App.queue.shift();
			App.getPage(obj.url, function(data, passon){App.getOneSetCB(data, passon)}, obj.passon);
		}
	},
	getOneSet:function(champ, role){
		var saveFolder = "ItemSets/" + App.betterDate() + " - SINGLES - ";

		if (App.leagueDirectory){
			saveFolder = App.leagueDirectory;
		}

		var url = "http://champion.gg/champion/" + champ + "/" + role;
		var passon = {champ:champ, role:role, saveFolder: saveFolder};
		App.getPage(url, function(data, passon){App.getOneSetCB(data, passon)}, passon);
	},
	getOneSetCB:function(page, passon){
		var champ = passon.champ;
		var role = passon.role;
		var saveFolder = passon.saveFolder;

		var data = App.getBetween(page, "matchupData.championData = ", "matchupData.patchHistory");
		var data = data.trim();
		var data = data.substring(0, data.length - 1); //Remove last ; so the JSON will parse

		try {
			var champJSON = JSON.parse(data);
		} catch (err) {
			App.log("No data is available for " + champ + " in " + role + " role", "#cc0000");
			return;
		}
		
		var currentPatch = App.getBetween(page, "<small>Patch <strong>", "</strong>");
		var firstMG = champJSON["firstItems"]["mostGames"];
		var firstHWP = champJSON["firstItems"]["highestWinPercent"];
		var fullMG = champJSON["items"]["mostGames"];
		var fullHWP = champJSON["items"]["highestWinPercent"];
		var skillsHWP = champJSON["skills"]["highestWinPercent"]["order"];
		var skillsMG = champJSON["skills"]["mostGames"]["order"];

		if (!firstMG["games"] || !firstHWP["games"] || !fullMG["games"] || !fullHWP["games"]){
			App.log("Full data is unavailable for " + champ + " in " + role + " role", "#cc0000");
			App.updateCount();
			//console.log("Woops, full data is unavailable for " + champ + " in " + role + " role");
			return;
		}

		var consumeItems = [2003, 2004, 2044, 2043, 2041, 2138, 2137, 2139, 2140];
		var trinketItems = [3340, 3341, 3342];

		var firstMGBlock = {
			"items": App.array_merge(App.getItems(firstMG, false, true), App.getItems(trinketItems, true)),
			"type": "Frequent Starters (" + firstMG["winPercent"].toString().slice(0, 2) + "% win/" + firstMG["games"] + " games)"
		};

		var firstHWPBlock = {
			"items": App.array_merge(App.getItems(firstHWP, false, true), App.getItems(trinketItems, true)),
			"type": "Highest Win Rate Starters (" + firstHWP["winPercent"].toString().slice(0, 2) + "% win/" + firstHWP["games"] + " games)"
		};
		var fullMGBlock = {
			"items": App.getItems(fullMG),
			"type": "Frequent:" + App.getSkillData(skillsMG) + " (" + fullMG["winPercent"].toString().slice(0, 2) + "% win/" + fullMG["games"] + " games)"
		};
		var fullHWPBlock = {
			"items": App.getItems(fullHWP),
			"type": "High Win:" + App.getSkillData(skillsHWP) + " (" + fullHWP["winPercent"].toString().slice(0, 2) + "% win/" + fullHWP["games"] + " games)"
		};

		//If the string length is too long the getSkillData method adds length
		// if (fullHWPBlock.type.length > 50 || fullMGBlock.type.length > 50){
		// 	console.log(fullHWPBlock.type.length, fullMGBlock.type.length);
		// }

		var consumeBlock = {
			"items": App.getItems(consumeItems, true),
			"type": "Consumables"
		};

		// console.log(firstHWP);
		// console.log(firstMG);

		var roleFormatted = champJSON["role"].substring(0, 1) + champJSON["role"].toLowerCase().substring(1);

		var blocks = [];

		if (App.isChecked("starters")){
			if (App.isChecked("frequent")){
				blocks.push(firstMGBlock);
			}
			if (App.isChecked("winrate")){
				blocks.push(firstHWPBlock);
			}
		}

		if (App.isChecked("frequent")){
			blocks.push(fullMGBlock);
		}

		if (App.isChecked("winrate")){
			blocks.push(fullHWPBlock);
		}

		if (App.isChecked("consumables")){
			blocks.push(consumeBlock);
		}

		var itemSetArr = {
			"map": "any",
			"isGlobalForChampions": false,
			"blocks": blocks,
			"associatedChampions": [],
			"title": roleFormatted + " " + currentPatch,
			"priority": false,
			"mode": "any",
			"isGlobalForMaps": true,
			"associatedMaps": [],
			"type": "custom",
			"sortrank": 1,
			"champion": champJSON["key"]
		};


		if (!App.leagueDirectory){
			saveFolder += "PATCH " + currentPatch.replace('.','_');
		}

		if (saveFolder == null) {
			saveFolder = champJSON["key"] + "/Recommended";
		} else {
			saveFolder = saveFolder + "/" + champJSON["key"] + "/Recommended";
		}

		if (!App.folderExists(saveFolder)) {
			App.mkdir(saveFolder);
		}

		var fileName = currentPatch.replace('.','_') + "_" + roleFormatted + ".json";
		fileName = saveFolder + "/" + fileName;

		var itemSetJSON = JSON.stringify(itemSetArr, null, '\t');
		App.writeFile(fileName, itemSetJSON);

		App.updateCount();
		App.log("Saved set for " + champ + " in " + role + " role", "#00cc00");
		//console.log("Saved set for " + champ + " in " + role + " role to: " + fileName);
	},
	updateCount:function(starting){
		starting = starting || false;
		if (starting){
			App.count.started++;
		} else {
			App.count.finished++;
			App.count.finished = (App.count.finished >= App.count.started) ? App.count.started : App.count.finished;

			if (App.sync){
				App.getAllSetsSync_Next();
			}

		}

		document.getElementById('status').innerHTML = "Patch: " + App.patch + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set: " + App.count.finished + "/" + App.count.started;
	},
	getSkillData:function(arr){
		var decode = ["Q", "W", "E", "R"];
		var totals = [0, 0, 0, 0];
		var results = [];
		for (skill in arr) {
			var index = parseInt(arr[skill]) - 1;
			totals[index]++;
			if (totals[index] >= 5){
				results.push(index);
			}
		}

		var decoded = [];
		for (skill in results){
			decoded.push(decode[results[skill]]);
		}

		var fulllist = [];
		for (skill in arr){
			fulllist.push(decode[arr[skill] - 1]);
		}

		var data = "" + fulllist.join("").slice(0, App.startSkillsNum) + " | " + decoded.join(">");

		if (App.isChecked("skills")){
			return " " + data;
		} else {
			return "";
		}

	},
	isChecked:function(id){
		return document.getElementById(id).checked;
	},
	array_merge:function(arr1, arr2){
		var result = [];
		return result.concat(arr1, arr2);
	},
	getPage:function(url, callback, passon) {
		var http = require("http");

		http.get(url, function(res) {

			var data = "";
			res.on('data', function (chunk) {
				data += chunk;
			});

			res.on("end", function(res) {
				callback(data, passon);
			});

		}).on("error", function(error) {
			App.log("Error: Unable to get " + url, "#ff0000");
			App.log(error, "#ff0000");
			App.updateCount();
			callback(null);
		});
	},
	getBetween:function(content, start, end){
		var result = content.split(start);
		if (result[1]){
			var result = result[1].split(end);
			return result[0];
		}
		return '';
	},
	getItems:function(input, fromPreset, starters) {
		var fromPreset = fromPreset || false;
		var starters = starters || false;
		var items = [];

		if (fromPreset) {
			for (item in input) {
				items.push({
					"count" : 1,
					"id" : input[item] + ""
				});
			}
		} else {
			var itemIDs = {};

			for (item in input["items"]) {
				var id = input["items"][item]["id"];
				id = (id == 2010) ? 2003 : id; //Convert total biscuit to health pot. If they have the mastery the pots will be biscuits.
				
				if (starters){
					if (itemIDs[id]){
						itemIDs[id]++;
					} else {
						itemIDs[id] = 1;
					}
				} else {
					items.push({
						"count": 1,
						"id": id + ""
					});
				}
			}

			if (starters){
				var count = 0;
				for (itemID in itemIDs) {
					items.push({
						"count": itemIDs[itemID],
						"id": itemID + ""
					});
				}
			}
		}

		return items;
	},
	readSettings:function(){
		var settings = App.readFile("riot_games_directory.ini");	

		if (settings){
			var path = settings.replace(/"/g, "") + "\\League of Legends\\Config\\Champions\\";

			if (App.folderExists(path)){
				App.leagueDirectory = path;
			} else {
				App.log("The path: " + path + " does not exist. Saving in champGG directory instead.", "#ff0000");
			}
		} else { //If we dont find a valid ini setting we try to auto set the default install directory
			var usual_path = "C:\\Riot Games";

			if (App.folderExists(usual_path)){
				App.writeFile("riot_games_directory.ini", usual_path);
				App.readSettings();
			}
		}
	},
	writeFile:function(path, data){
		try {
			var fs = require('fs');
			fs.writeFileSync(path, data);
		} catch (e){
			console.log("Error writing file [" + path + "]");
		}
	},
	readFile:function(path){
		try {
			var fs = require('fs');
			return fs.readFileSync(path, 'utf8');
		} catch (e){
			console.log("Error reading file [" + path + "]");
		}
	},
	folderExists:function(path){
		var fs = require('fs');
		try {
			var stats = fs.lstatSync(path);
			//console.log(stats)
			if (stats.isDirectory()) {
				return true;
			}
		} catch (e){
			return false;
		}
	},
	rmdir:function(path){
		var fs = require('fs');
		if (fs.existsSync(path)){
			fs.readdirSync(path).forEach(function(file, index){
				var curPath = path + "/" + file;
				if (fs.lstatSync(curPath).isDirectory()){ //recurse
					App.rmdir(curPath);
				} else { // delete file
					fs.unlinkSync(curPath);
				}
			});
			fs.rmdirSync(path);
		}
	},
	mkdir:function(path, root){
		var fs = require('fs');
		var dirs = path.split('/'), dir = dirs.shift(), root = (root || '') + dir + '/';

		try { fs.mkdirSync(root); }
		catch (e) {
			//dir wasn't made, something went wrong
			if(!fs.statSync(root).isDirectory()) throw new Error(e);
		}

		return !dirs.length||App.mkdir(dirs.join('/'), root);
	},
	log:function(data, color){
		var ele = document.getElementById("output");
		ele.innerHTML += '<font color="' + color + '">' + data + "</font><br>";
		ele.scrollTop = ele.scrollHeight;
	},
	betterDate:function(){
		var months= ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
		var today = new Date();
		var year = today.getFullYear();
		var month = today.getMonth();
		var day = today.getDate();
		day = (day < 10) ? "0" + day : day;
		
		var date = day + " " + months[month] + " " + year;
		return 	date;
	},
	toggleConfig:function(){
		var ele = document.getElementById('ui2');
		ele.style.display = (ele.style.display == "block") ? "none" : "block";
	},
	setConfig:function(data){
		if (data == "connection"){
			App.sync = !App.sync;

			if (App.sync){
				alert('Slow mode enabled.\nThe app will now make requests to champion.gg one at a time.');
			} else {
				alert('Fast mode enabled.\nThe app will now make requests to champion.gg all at once.');
			}
			return;
		}

		var restored = App.readFile("riot_games_directory.ini") || "";
		var data = prompt("Path to Riot Games folder (usually C:\\Riot Games)", restored);
		var path = data.replace(/"/g, "");

		if (App.folderExists(path)){
			App.writeFile("riot_games_directory.ini", path);
		} else {
			alert("The path: " + path + " does not exist");
		}
	},
	openURL:function(url){
		window.open(url);
	}
};

</script>
<body onload="App.clean()">

<div id="ui">
	<center>
		<br>
		<b>Include</b>
		<table>
			<tr>
				<td title="Include the most popular builds" style="width:150px;">frequent builds</td><td> <input id="frequent" type="checkbox" class="checkbox"></td>
			</tr>
			<tr>
				<td title="Include builds with the highest win rate">high win% builds</td><td> <input id="winrate" type="checkbox" class="checkbox" checked></td>
			</tr>
			<tr>
				<td title="Include a set specific for starter items">starter items</td><td> <input id="starters" type="checkbox" class="checkbox" checked></td>
			</tr>
			<tr>
				<td title="Include a generic consumable set for all champions">consumables</td><td> <input id="consumables" type="checkbox" class="checkbox" checked></td>
			</tr>
			<tr>
				<td title="Include first 5 skills to build and skill max order">skill order</td><td> <input id="skills" type="checkbox" class="checkbox" checked></td>
			</tr>
			<tr>
				<td title="Remove old champion.gg item sets. Will not remove custom sets you have created">remove old sets</td><td> <input id="remold" type="checkbox" class="checkbox" checked></td>
			</tr>
		</table>
		</table>
		<br>
		<input type="button" value="Download" onclick="App.ini();" class="btn btn-default"> 
		<input type="button" value="Help" onclick="App.toggleConfig();" class="btn btn-default">
		<br><br>
	</center>
</div>

<div id="ui2" style="font-size:11px;display:none;">	
	<b>Connection Errors?</b>
	<br><i>Toggle between fast and slow download mode (Default fast)</i>
	<br>1. Click <a href="javascript:App.setConfig('connection')">here</a>
	<br><br>
	<b>League Directory Setup</b>
	<br><i>These steps are needed if LOL is not installed at C:\Riot Games</i>
	<br>1. Find your riot games folder
	<br>2. Hold shift and right click on the Riot Games folder
	<br>3. Click "Copy as Path"
	<br>4. Click <a href="javascript:App.setConfig()">here</a> and paste the path you just copied
	<br>5. Item sets will now be auto saved into the LOL client
	<br><br>
	<b>I can't get League Directory Setup to work!</b>
	<br> Don't worry, you can still copy and paste the item sets in to your league directory yourself. Below is where you copy the files to manually once you find your install directory.
	<br><br><b>Where to manually save item sets?</b>
	<br>\Riot Games\League of Legends\Config\Champions\
</div>


<div id="output" style="height:480px;width:100%;overflow-y:scroll;font-size:10px;color:#c0c0c0;display:none;" class="well"></div>

<span style="font-size:10px;color:#c0c0c0;" id="status"></span>

<span style="font-size:10px;color:#c0c0c0;" id="credits">
	<center>
		<br>
		Original PHP script by ebildude123 <a href="javascript:App.openURL('https://github.com/ebildude123/champion.gg-item-set-creator')">Github</a>
		<br>
		Item Data provided by <a href="javascript:App.openURL('http://champion.gg')">http://champion.gg/</a>
		<br>
		Ported by Gavin Delphia
	</center>
</span>

</body>
</html>