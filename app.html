<!--
Ported by Gavin Delphia in 2015
-->

<!DOCTYPE html>
<html lang="en">

<head>
<title>ChampGG ItemSet Downloader</title>

<style>
html {
  font-family: sans-serif;
  -webkit-text-size-adjust: 100%;
	  -ms-text-size-adjust: 100%;
}
body{
	margin: 5px;
}
div {
	border: 0px solid;
}
</style>


<script>
var App = {
	//Experimental feature to save the files to the league directory rather than the ItemSets directory
	leagueDirectory: "", 
	count: {started: 0, finished: 0},
	patch: "",
	ini:function(){
		document.getElementById('ui2').style.display = "none";
		App.readSettings();
		App.getAllSets();
		// App.getOneSet("Fizz", "Top");
		// App.getOneSet("Fizz", "Middle");
		// App.getOneSet("Fizz", "Jungle");
		// App.getOneSet("Kayle", "Top");
		// App.getOneSet("Kayle", "ADC");
		// App.getOneSet("Kayle", "Jungle");
		//Middle, ADC, Top, Jungle, Support

		document.getElementById("ui").style.display = "none";
		document.getElementById("output").style.display = "block";
	},
	getAllSets:function(){
		App.getPage("http://champion.gg/", function(data){App.getAllSetsCB(data)});
	},
	getAllSetsCB:function(data){
		if (data){
			//console.log("Creating item sets for all champions...");
			App.log("Creating item sets for all champions...", "#c0c0c0");
			var saveFolder = "ItemSets/" + App.betterDate() + " - ";
			var list = data.match(/<a href="([^"]*)" style="display:block">/g);
			App.patch = App.getBetween(data, "<small>Patch <strong>", "</strong>");
			App.log("Champion.gg item set data is for patch " + App.patch + "<br>", "#c0c0c0");
			if (App.leagueDirectory){
				saveFolder = App.leagueDirectory;
				App.log("Auto Save Feature Enabled", "#0000ee");
				App.log(saveFolder + "<br>", "#0000ee");
			}

			for (var champPage in list){
				App.updateCount(true);
				var data = list[champPage].split("/");
				var champ = data[2];
				var role = data[3].split('"')[0];
				var url = "http://champion.gg/champion/" + champ + "/" + role;

				var passon = {champ:champ, role:role, saveFolder: saveFolder};
				App.getPage(url, function(data, passon){App.getOneSetCB(data, passon)}, passon);
			}
		} else {
			//console.log("Error");
		}
	},
	getOneSet:function(champ, role){
		var saveFolder = "ItemSets/" + App.betterDate() + " - SINGLES - ";

		if (App.leagueDirectory){
			saveFolder = App.leagueDirectory;
		}

		var url = "http://champion.gg/champion/" + champ + "/" + role;
		var passon = {champ:champ, role:role, saveFolder: saveFolder};
		App.getPage(url, function(data, passon){App.getOneSetCB(data, passon)}, passon);
	},
	getOneSetCB:function(page, passon){
		var champ = passon.champ;
		var role = passon.role;
		var saveFolder = passon.saveFolder;

		var data = App.getBetween(page, "matchupData.championData = ", "matchupData.patchHistory");
		var data = data.trim();
		var data = data.substring(0, data.length - 1); //Remove last ; so the JSON will parse

		try {
			var champJSON = JSON.parse(data);
		} catch (err) {
			App.log("No data is available for " + champ + " in " + role + " role", "#cc0000");
			return;
		}
		
		var currentPatch = App.getBetween(page, "<small>Patch <strong>", "</strong>");
		var firstMG = champJSON["firstItems"]["mostGames"];
		var firstHWP = champJSON["firstItems"]["highestWinPercent"];
		var fullMG = champJSON["items"]["mostGames"];
		var fullHWP = champJSON["items"]["highestWinPercent"];
		var skillsHWP = champJSON["skills"]["highestWinPercent"]["order"];
		var skillsMG = champJSON["skills"]["mostGames"]["order"];

		if (!firstMG["games"] || !firstHWP["games"] || !fullMG["games"] || !fullHWP["games"]){
			App.log("Full data is unavailable for " + champ + " in " + role + " role", "#cc0000");
			App.updateCount();
			//console.log("Woops, full data is unavailable for " + champ + " in " + role + " role");
			return;
		}

		var consumeItems = [2003, 2004, 2044, 2043, 2041, 2138, 2137, 2139, 2140];
		var trinketItems = [3340, 3341, 3342];

		var firstMGBlock = {
			"items": App.array_merge(App.getItems(firstMG, false, true), App.getItems(trinketItems, true)),
			"type": "Most Frequent Starters (" + firstMG["winPercent"] + "% wins over " + firstMG["games"] + " games)"
		};

		var firstHWPBlock = {
			"items": App.array_merge(App.getItems(firstHWP, false, true), App.getItems(trinketItems, true)),
			"type": "Highest Win Rate Starters (" + firstHWP["winPercent"] + "% wins over " + firstHWP["games"] + " games)"
		};
		var fullMGBlock = {
			"items": App.getItems(fullMG),
			"type": "Most Freq Build" + App.getSkillData(skillsMG) + " (" + fullMG["winPercent"] + "% wins over " + fullMG["games"] + " games)"
		};
		var fullHWPBlock = {
			"items": App.getItems(fullHWP),
			"type": "Highest Win Build" + App.getSkillData(skillsHWP) + " (" + fullHWP["winPercent"] + "% wins over " + fullHWP["games"] + " games)"
		};
		var consumeBlock = {
			"items": App.getItems(consumeItems, true),
			"type": "Consumables"
		};

		// console.log(firstHWP);
		// console.log(firstMG);

		var roleFormatted = champJSON["role"].substring(0, 1) + champJSON["role"].toLowerCase().substring(1);

		var blocks = [];

		if (App.isChecked("starters")){
			if (App.isChecked("frequent")){
				blocks.push(firstMGBlock);
			}
			if (App.isChecked("winrate")){
				blocks.push(firstHWPBlock);
			}
		}

		if (App.isChecked("frequent")){
			blocks.push(fullMGBlock);
		}

		if (App.isChecked("winrate")){
			blocks.push(fullHWPBlock);
		}

		if (App.isChecked("consumables")){
			blocks.push(consumeBlock);
		}

		var itemSetArr = {
			"map": "any",
			"isGlobalForChampions": false,
			"blocks": blocks,
			"associatedChampions": [],
			"title": roleFormatted + " " + currentPatch,
			"priority": false,
			"mode": "any",
			"isGlobalForMaps": true,
			"associatedMaps": [],
			"type": "custom",
			"sortrank": 1,
			"champion": champJSON["key"]
		};


		if (!App.leagueDirectory){
			saveFolder += "PATCH " + currentPatch.replace('.','_');
		}

		if (saveFolder == null) {
			saveFolder = champJSON["key"] + "/Recommended";
		} else {
			saveFolder = saveFolder + "/" + champJSON["key"] + "/Recommended";
		}

		if (!App.folderExists(saveFolder)) {
			App.mkdir(saveFolder);
		}

		var fileName = currentPatch.replace('.','_') + "_" + roleFormatted + ".json";
		fileName = saveFolder + "/" + fileName;

		var itemSetJSON = JSON.stringify(itemSetArr, null, '\t');
		App.writeFile(fileName, itemSetJSON);

		App.updateCount();
		App.log("Saved set for " + champ + " in " + role + " role", "#00cc00");
		//console.log("Saved set for " + champ + " in " + role + " role to: " + fileName);
	},
	updateCount:function(starting){
		starting = starting || false;
		if (starting){
			App.count.started++;
		} else {
			App.count.finished++;
			App.count.finished = (App.count.finished >= App.count.started) ? App.count.started : App.count.finished;
		}

		document.getElementById('status').innerHTML = "Patch: " + App.patch + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set: " + App.count.finished + "/" + App.count.started;
	},
	getSkillData:function(arr){
		var decode = ["Q", "W", "E"];
		var totals = [0, 0, 0, 0];
		var results = [];
		for (skill in arr) {
			var index = parseInt(arr[skill]) - 1;
			totals[index]++;
			if (totals[index] >= 5){
				results.push(index);
			}
		}

		var decoded = [];
		for (skill in results){
			decoded.push(decode[results[skill]]);
		}

		if (App.isChecked("skills")){
			return ", Skill: " + decoded.join(">");
		} else {
			return "";
		}

	},
	isChecked:function(id){
		return document.getElementById(id).checked;
	},
	array_merge:function(arr1, arr2){
		var result = [];
		return result.concat(arr1, arr2);
	},
	getPage:function(url, callback, passon) {
		var http = require("http");

		http.get(url, function(res) {

			var data = "";
			res.on('data', function (chunk) {
				data += chunk;
			});

			res.on("end", function(res) {
				callback(data, passon);
			});

		}).on("error", function(error) {
			App.log("Error: Unable to get " + url, "#ff0000");
			App.log(error, "#ff0000");
			App.updateCount();
			callback(null);
		});
	},
	getBetween:function(content, start, end){
		var result = content.split(start);
		if (result[1]){
			var result = result[1].split(end);
			return result[0];
		}
		return '';
	},
	isInArray:function(arr, key){
		for (item in arr){
		}
	},
	getItems:function(input, fromPreset, starters) {
		var fromPreset = fromPreset || false;
		var starters = starters || false;
		var items = [];
		if (fromPreset) {
			for (item in input) {
				items.push({
					"count" : 1,
					"id" : input[item] + ""
				});
			}
		} else {
			var itemIDs = {};

			for (item in input["items"]) {
				var id = input["items"][item]["id"];
				id = (id == 2010) ? 2003 : id; //Convert total biscuit to health pot. If they have the mastery the pots will be biscuits.
				
				if (starters){
					if (itemIDs[id]){
						itemIDs[id]++;
					} else {
						itemIDs[id] = 1;
					}
				} else {
					items.push({
						"count": 1,
						"id": id + ""
					});
				}
			}

			if (starters){
				var count = 0;
				for (itemID in itemIDs) {
					items.push({
						"count": itemIDs[itemID],
						"id": itemID + ""
					});
				}
			}
		}

		return items;
	},
	readSettings:function(){
		var settings = App.readFile("riot_games_directory.ini");	

		if (settings){
			var path = settings.replace(/"/g, "") + "\\League of Legends\\Config\\Champions\\";

			if (App.folderExists(path)){
				App.leagueDirectory = path;
			} else {
				App.log("The path: " + path + " does not exist. Saving in champGG directory instead.", "#ff0000");
			}
		}
	},
	writeFile:function(path, data){
		try {
			var fs = require('fs');
			fs.writeFileSync(path, data);
		} catch (e){
			console.log("Error writing file [" + path + "]");
		}
	},
	readFile:function(path){
		try {
			var fs = require('fs');
			return fs.readFileSync(path, 'utf8');
		} catch (e){
			console.log("Error reading file [" + path + "]");
		}
	},
	folderExists:function(path){
		var fs = require('fs');
		try {
			var stats = fs.lstatSync(path);
			console.log(stats)
			if (stats.isDirectory()) {
				return true;
			}
		} catch (e){
			return false;
		}
	},
	mkdir:function(path, root){
		var fs = require('fs');
		var dirs = path.split('/'), dir = dirs.shift(), root = (root || '') + dir + '/';

		try { fs.mkdirSync(root); }
		catch (e) {
			//dir wasn't made, something went wrong
			if(!fs.statSync(root).isDirectory()) throw new Error(e);
		}

		return !dirs.length||App.mkdir(dirs.join('/'), root);
	},
	log:function(data, color){
		var ele = document.getElementById("output");
		ele.innerHTML += '<font color="' + color + '">' + data + "</font><br>";
		ele.scrollTop = ele.scrollHeight;
	},
	betterDate:function(){
		var months= ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
		var today = new Date();
		var year = today.getFullYear();
		var month = today.getMonth();
		var day = today.getDate();
		day = (day < 10) ? "0" + day : day;
		
		var date = day + " " + months[month] + " " + year;
		return 	date;
	},
	toggleConfig:function(){
		var ele = document.getElementById('ui2');
		ele.style.display = (ele.style.display == "block") ? "none" : "block";
	},
	setConfig:function(){
		var restored = App.readFile("riot_games_directory.ini") || "";
		var data = prompt("Path to Riot Games folder (usually C:\\Riot Games)", restored);
		var path = data.replace(/"/g, "");

		if (App.folderExists(path)){
			App.writeFile("riot_games_directory.ini", path);
		} else {
			alert("The path: " + path + " does not exist");
		}
	},
	openURL:function(url){
		window.open(url);
	}
};

</script>
<body>

<div id="ui">
	<center>
		<br><br>
		<b>Include</b>
		<table>
			<tr>
				<td>frequent builds</td><td> <input id="frequent" type="checkbox" class="form-control"></td>
			</tr>
			<tr>
				<td>high win% builds</td><td> <input id="winrate" type="checkbox" class="form-control" checked></td>
			</tr>
			<tr>
				<td>starter items</td><td> <input id="starters" type="checkbox" class="form-control" checked></td>
			</tr>
			<tr>
				<td>consumables</td><td> <input id="consumables" type="checkbox" class="form-control" checked></td>
			</tr>
			<tr>
				<td>skill order</td><td> <input id="skills" type="checkbox" class="form-control" checked></td>
			</tr>
		</table>

		<input type="button" value="Download" onclick="App.ini();"> 
		<input type="button" value="Config" onclick="App.toggleConfig();">
		<br><br>
	</center>
</div>

<div id="ui2" style="font-size:11px;display:none;">
		<br><br><b>Configuration</b>
		<br>1. Find your riot games folder (usually C:\Riot Games)
		<br>2. Hold shift and right click on the Riot Games folder
		<br>3. Click "Copy as Path"
		<br>4. Click <a href="javascript:App.setConfig()">here</a> and paste the path you just copied
		<br><br>
		Now when you download the item sets they will automatically be saved into the league client.
		<br><br>
		<b>I can't get config to work!</b><br> Don't worry, you can still copy and paste the item sets in to your league directory yourself. Below is where you save the files manually once you find your install directory.
		<br><br><b>Where to manually save item sets</b>
		<br>\Riot Games\League of Legends\Config\Champions\
</div>


<div id="output" style="height:510px;width:100%;overflow-y:scroll;font-size:10px;color:#c0c0c0;display:none;"></div>
<span style="font-size:10px;color:#c0c0c0;" id="status"></span><br>
<span style="font-size:10px;color:#c0c0c0;" id="credits">
<center><br>
Original PHP script by ebildude123 <a href="javascript:App.openURL('https://github.com/ebildude123/champion.gg-item-set-creator')">Github</a><br>
Item Data provided by <a href="javascript:App.openURL('http://champion.gg')">http://champion.gg/</a><br>
Ported by Gavin Delphia
</center>
</span>

</body>
</html>